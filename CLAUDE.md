# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

A Chrome Extension (Manifest V3) that provides a WebSocket/MQTT debugging tool via the Side Panel API. It supports both WebSocket and MQTT-over-WebSocket connections with features like message logging, connection history, idle timeout auto-disconnect, and theme switching.

## Build and Development

```bash
# Development build with hot reload
npm run dev

# Production build
npm run build

# Build and watch for changes
npm run watch
```

**Important**: The build outputs to `dist/` directory, not `websocket-tool-dist/`. The `websocket-tool-dist/` appears to be a packaged/archive version.

After building, load the extension in Chrome:
1. Navigate to `chrome://extensions/`
2. Enable "Developer mode"
3. Click "Load unpacked"
4. Select the `dist/` folder

## Architecture

### File Structure

```
src/
├── sidepanel.html    # Main HTML structure for the side panel UI
├── sidepanel.js      # All application logic (no framework)
├── styles.css        # Complete styling with CSS variables for theming
public/
├── manifest.json     # Chrome extension manifest (V3)
└── icons/           # Extension icons
dist/                # Build output (generated by Vite)
```

### Key Components

**Application State** (`sidepanel.js`):
- `ws` - WebSocket connection instance
- `mqttClient` - MQTT client instance (using `mqtt` npm package)
- `mode` - Either `'ws'` or `'mqtt'`
- `status` - Connection state: `'connecting'`, `'connected'`, `'disconnected'`
- `logs` - Array of log entries `{kind, message, time}`
- `history` - Message history for quick re-send
- `scrollLocked` - Whether auto-scroll is disabled
- `idleSeconds` - Auto-disconnect timeout setting

**Storage Keys** (`chrome.storage.local`):
- `ws:url` - Last used connection URL
- `ws:idleSeconds` - Idle timeout setting
- `ws:history` - Message history array
- `ws:historySize` - Max history size (1-50)
- `ws:theme` - Current theme (`'light'` or `'dark'`)
- `ws:connConfig` - Connection configuration object

### Connection Modes

**WebSocket Mode**: Direct WebSocket connection using native browser `WebSocket` API.

**MQTT Mode**: Uses the `mqtt` npm package (MQTT.js) with WebSocket transport. Requires Node.js polyfills for `stream`, `buffer`, `process`, `util`, `events` - provided by `vite-plugin-node-polyfills`.

### MQTT Specifics

- Uses MQTT v3.1.1 (protocolVersion: 4)
- Default QoS: 0
- Supports username/password authentication
- Auto-reconnect option (5 second interval)
- Dynamic topic subscription/unsubscription when topic field changes
- `stopMqttClient()` function handles complete cleanup including internal timers

### CSS Theming

Uses CSS custom properties for light/dark themes. Theme is controlled via `data-theme` attribute on `<html>` element. All colors are defined in `:root` and overridden in `[data-theme="dark"]`.

### Vite Configuration Notes

- Root is `src/` directory
- Entry point is `src/sidepanel.html`
- Outputs to `../dist`
- Requires node polyfills for MQTT library support
- Uses `base: './'` for relative path resolution in extension context

### UI Components

- **Settings Panel**: Slide-in drawer with advanced connection config
- **Log Area**: Message bubbles styled as rx (received), tx (sent), or sys (system)
- **History Chips**: Clickable quick-fill buttons for previous messages
- **Status Indicator**: Color-coded dot (red/yellow/green) for connection state

## Development Notes

- No framework - vanilla JavaScript with direct DOM manipulation
- Font Awesome via CDN for icons
- Inter font for UI, JetBrains Mono for code/monospace
- MQTT client cleanup is critical - the `stopMqttClient()` function handles removing all listeners and clearing timers to prevent memory leaks
- Input in footer uses `Ctrl+Enter` to send messages
- URL can be manually entered or built from the settings panel configuration
