# 多主题窗口功能 - 实施计划

## 一、需求分析

### 1.1 当前限制

目前扩展在 MQTT 模式下只支持单个主题订阅：
- 用户只能订阅一个 topic
- 所有消息都显示在同一个日志区域
- 无法同时监控多个不同的主题
- 切换主题需要先取消订阅当前主题，再订阅新主题

### 1.2 用户痛点

在 IoT 开发和调试场景中，常见以下需求：
- 同时监控多个传感器数据（如 `home/temperature`、`home/humidity`、`home/light`）
- 监控设备状态主题（`device/status`）和控制主题（`device/command`）
- 不同应用的系统消息（`$SYS/broker/...`）和应用消息分开查看
- 按业务逻辑分组查看消息（如客厅、卧室、厨房的设备）

### 1.3 功能目标

实现**多主题标签页**系统，允许用户：
- 同时订阅多个 MQTT 主题
- 为每个主题创建独立的日志视图
- 通过标签页切换查看不同主题的消息
- 为每个主题独立配置显示选项
- 支持主题分组管理
- 保存和恢复主题订阅配置

---

## 二、UI/UX 设计

### 2.1 界面布局重构

#### 2.1.1 整体布局变化

```
原始布局:
┌─────────────────────────────────────────────┐
│  Header: URL + Connect + Settings            │
├─────────────────────────────────────────────┤
│                                             │
│  Single Log Area (所有消息混合显示)          │
│                                             │
├─────────────────────────────────────────────┤
│  Footer: History + Input                    │
└─────────────────────────────────────────────┘

新布局:
┌─────────────────────────────────────────────┐
│  Header: URL + Connect + Settings            │
├─────────────────────────────────────────────┤
│  ┌─ Topic 1 ─┬─ Topic 2 ─┬─ + ─┬─ ⚙ ─┐    │  ← Tab Bar
├─┴───────────┴───────────┴─────┴─────┤─────┤
│                                             │
│  Topic 1 Log Area (仅显示 Topic 1 消息)     │
│                                             │
├─────────────────────────────────────────────┤
│  Footer: History + Input                    │
└─────────────────────────────────────────────┘
```

#### 2.1.2 Tab Bar 设计

**位置**: Header 和 Log Area 之间

**Tab 结构**:
```
┌─────────────────────┬─────────────────────┬────┬────┐
│  🏠 home/living     │  💡 home/light      │ +  │ ⚙  │
│  ● 12 messages      │  ● 5 messages       │    │    │
└─────────────────────┴─────────────────────┴────┴────┘
    [Active Tab]           [Inactive Tab]
```

**Tab 状态**:
- **活动状态**: 高亮背景，底部边框强调
- **非活动状态**: 半透明背景，鼠标悬停时高亮
- **悬停状态**: 显示关闭按钮
- **新增按钮**: 点击添加新主题
- **管理按钮**: 打开主题管理面板

**Tab 内容**:
- 主题名称（截断显示，最多 20 字符）
- 消息计数徽章（未读消息数或总消息数）
- 关闭按钮（悬停时显示）

### 2.2 主题管理面板

#### 2.2.1 面板布局

滑入式抽屉，与现有 Settings Panel 类似，从右侧滑入

```
┌──────────────────────────────────────────┐
│  主题管理                        [×]      │
├──────────────────────────────────────────┤
│                                          │
│  已订阅主题                              │
│  ┌────────────────────────────────────┐ │
│  │ 🏠 home/livingroom         [删除]  │ │
│  │ QoS: 0 | 消息: 156 | 保存: ✓      │ │
│  ├────────────────────────────────────┤ │
│  │ 💡 home/light/#            [删除]  │ │
│  │ QoS: 0 | 消息: 42  | 保存: ✓      │ │
│  ├────────────────────────────────────┤ │
│  │ 🌡️ home/sensors/temperature [删除] │ │
│  │ QoS: 1 | 消息: 89  | 保存: ✓      │ │
│  └────────────────────────────────────┘ │
│                                          │
│  [+ 添加主题]                            │
│                                          │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━  │
│                                          │
│  快速添加                                │
│  常用系统主题:                           │
│  • $SYS/broker/#                        │
│  • $SYS/broker/clients/#                │
│                                          │
├──────────────────────────────────────────┤
│              [保存配置]  [关闭]          │
└──────────────────────────────────────────┘
```

#### 2.2.2 添加主题对话框

模态对话框，用于输入新主题信息

```
┌──────────────────────────────────────────┐
│  添加主题                       [×]      │
├──────────────────────────────────────────┤
│                                          │
│  主题名称                                │
│  ┌────────────────────────────────────┐ │
│  │ home/sensors/#                     │ │
│  └────────────────────────────────────┘ │
│                                          │
│  显示名称（可选）                        │
│  ┌────────────────────────────────────┐ │
│  │ 🏠 All Sensors                      │ │
│  └────────────────────────────────────┘ │
│                                          │
│  QoS 等级                                │
│  ○ 0 - 最多一次                         │
│  ● 1 - 至少一次                         │
│  ○ 2 - 恰好一次                         │
│                                          │
│  选项                                    │
│  ☑ 保存到配置                            │
│  ☑ 订阅后自动切换到该标签                │
│                                          │
├──────────────────────────────────────────┤
│           [取消]           [添加]        │
└──────────────────────────────────────────┘
```

### 2.3 每个 Tab 的独立功能

#### 2.3.1 Tab 工具栏

在每个 Log Area 上方添加 Tab 特定的工具栏：

```
┌─────────────────────────────────────────────┐
│ home/livingroom                              │
│ [清空] [导出] [暂停] [过滤...] [配置]        │
├─────────────────────────────────────────────┤
│                                             │
│  该主题的日志内容                            │
```

**工具栏按钮**:
- **清空**: 清空该主题的日志
- **导出**: 导出该主题的消息为 JSON/CSV
- **暂停**: 暂停该主题的消息接收（保持订阅但不显示）
- **过滤**: 按关键词/正则过滤该主题的消息
- **配置**: 打开该主题的配置面板（QoS、显示名称、颜色等）

#### 2.3.2 主题配置选项

每个主题可独立配置：
- **显示名称**: 自定义标签显示名称
- **颜色标识**: 为不同主题设置颜色（便于区分）
- **消息限制**: 该主题保留的最大消息数
- **自动滚动**: 该主题是否自动滚动
- **JSON 格式化**: 是否自动格式化 JSON 消息
- **声音提醒**: 收到消息时播放提示音
- **未读计数**: 是否在 Tab 上显示未读消息数

### 2.4 状态指示增强

#### 2.4.1 Tab 状态指示

每个 Tab 显示该主题的订阅状态：
- **已订阅**: 绿色指示器
- **订阅中**: 橙色脉冲动画
- **已暂停**: 黄色指示器 + 暂停图标
- **订阅失败**: 红色指示器

#### 2.4.2 全局状态概览

在 Header 中添加主题统计：
```
● 已连接 | 3 个主题 | 12 条/秒
```

---

## 三、技术架构设计

### 3.1 数据结构设计

#### 3.1.1 主题会话对象

```javascript
// TopicSession 数据结构
{
  id: string,              // 唯一标识符 (UUID)
  topic: string,           // MQTT 主题名称
  displayName: string,     // 显示名称
  qos: number,             // QoS 等级 (0, 1, 2)
  color: string,           // 主题颜色标识
  logs: Array<LogEntry>,   // 该主题的日志数组
  isSubscribed: boolean,   // 订阅状态
  isPaused: boolean,       // 是否暂停显示
  isMuted: boolean,        // 是否静音
  maxLogs: number,         // 最大日志数
  autoScroll: boolean,     // 是否自动滚动
  jsonFormat: boolean,     // 是否格式化 JSON
  filter: string,          // 过滤关键词
  unreadCount: number,     // 未读消息数
  totalReceived: number,   // 总接收消息数
  lastMessage: timestamp,  // 最后消息时间
  created: timestamp,      // 创建时间
}
```

#### 3.1.2 应用状态扩展

```javascript
// 新增全局状态
{
  // 现有状态...
  mode: 'ws' | 'mqtt',
  status: Status,
  ws: WebSocket | null,
  mqttClient: MQTT.Client | null,

  // 新增多主题状态
  activeTopicId: string | null,     // 当前活动主题 ID
  topicSessions: Map<string, TopicSession>,  // 所有主题会话
  topicOrder: string[],              // Tab 排序顺序
  globalMaxLogs: number,            // 全局最大日志数
  notificationsEnabled: boolean,     // 是否启用通知
}
```

### 3.2 存储方案设计

#### 3.2.1 Chrome Storage Keys

```javascript
const storageKeys = {
  // 现有 keys...
  url: 'ws:url',
  history: 'ws:history',
  theme: 'ws:theme',

  // 新增多主题 keys
  topicConfigs: 'ws:topicConfigs',      // 主题配置数组
  activeTopicId: 'ws:activeTopicId',    // 当前活动主题 ID
  topicOrder: 'ws:topicOrder',          // Tab 顺序
  globalSettings: 'ws:globalTopicSettings', // 全局设置
};
```

#### 3.2.2 持久化策略

| 数据 | 存储位置 | 保存时机 | 保留策略 |
|------|---------|---------|---------|
| 主题配置列表 | chrome.storage.local | 添加/删除/修改主题时 | 永久 |
| 当前活动主题 ID | chrome.storage.local | 切换 Tab 时 | 永久 |
| 主题消息日志 | 内存（不持久化） | - | 关闭清除 |
| Tab 顺序 | chrome.storage.local | 拖拽排序后 | 永久 |
| 全局设置 | chrome.storage.local | 修改设置时 | 永久 |

#### 3.2.3 数据恢复流程

应用启动时：
1. 从 `chrome.storage.local` 读取 `topicConfigs`
2. 重建 `TopicSession` 对象（但 logs 为空）
3. 恢复 Tab 顺序和活动主题 ID
4. 连接 MQTT 后自动订阅所有保存的主题

### 3.3 消息路由设计

#### 3.3.1 MQTT 消息分发

```
MQTT Client 收到消息
        ↓
判断消息主题
        ↓
遍历 topicSessions
        ↓
匹配通配符主题 (如 home/+/sensor)
        ↓
分发到匹配的所有会话
        ↓
更新各自的 logs 数组
        ↓
如果该 Tab 是活动的 → 渲染 UI
如果该 Tab 非活动的 → 更新未读计数
```

#### 3.3.2 主题匹配算法

实现 MQTT 主题匹配逻辑：
- 精确匹配: `home/temp` == `home/temp`
- 单级通配符: `home/+/temp` 匹配 `home/living/temp`
- 多级通配符: `home/#` 匹配 `home/living/room/temp`

### 3.4 组件模块设计

#### 3.4.1 新增核心模块

| 模块 | 职责 | 主要函数 |
|------|------|---------|
| **TopicManager** | 主题会话管理 | `createSession()`, `deleteSession()`, `switchSession()` |
| **TopicRouter** | 消息路由分发 | `routeMessage()`, `matchTopic()` |
| **TabRenderer** | Tab Bar 渲染 | `renderTabs()`, `updateTabBadge()` |
| **SessionStorage** | 会话持久化 | `saveConfigs()`, `loadConfigs()` |
| **NotificationManager** | 通知提醒 | `showNotification()`, `playSound()` |

#### 3.4.2 现有模块修改

| 模块 | 修改内容 |
|------|---------|
| **ConnectionManager** | MQTT 连接后自动订阅所有主题；断开时清除订阅状态 |
| **LogRenderer** | 改为渲染当前活动会话的日志；添加会话参数 |
| **StorageManager** | 添加主题配置的读写方法 |
| **UIEvents** | 添加 Tab 相关事件处理（点击、关闭、拖拽） |

---

## 四、实施步骤

### 4.1 阶段划分

#### 阶段 1: 基础架构（核心数据结构）
**目标**: 建立多主题数据模型和管理机制

1. 定义 `TopicSession` 数据结构和类型
2. 实现 `TopicManager` 核心类
   - 创建、删除、切换会话
   - 会话状态管理
3. 实现主题存储和恢复机制
4. 添加单元测试（数据结构操作）

#### 阶段 2: 消息路由系统
**目标**: 实现消息正确分发到各个会话

1. 实现 MQTT 主题匹配算法
2. 创建 `TopicRouter` 消息路由器
3. 集成到现有 MQTT 消息处理流程
4. 添加多主题订阅/取消订阅逻辑
5. 测试消息路由正确性

#### 阶段 3: UI 组件开发
**目标**: 实现 Tab Bar 和相关 UI

1. 创建 Tab Bar HTML 结构
2. 实现 Tab 样式（活动/非活动/悬停状态）
3. 开发 `TabRenderer` 渲染逻辑
4. 实现 Tab 切换功能
5. 添加 Tab 关闭和新增按钮
6. 实现拖拽排序功能

#### 阶段 4: 主题管理面板
**目标**: 实现主题配置管理界面

1. 创建主题管理面板 HTML/CSS
2. 实现主题列表显示
3. 开发添加主题对话框
4. 实现主题配置表单
5. 添加删除/编辑功能
6. 集成到现有 Settings Panel

#### 阶段 5: 独立会话功能
**目标**: 为每个会话提供独立功能

1. 实现会话独立的日志显示
2. 添加会话工具栏（清空、导出、暂停）
3. 实现会话级别的过滤功能
4. 添加会话配置选项
5. 实现未读消息计数

#### 阶段 6: WebSocket 模式适配（可选，延后实施）
**目标**: 为 WebSocket 模式提供类似的多窗口功能

**决定**: MVP 阶段 WebSocket 模式保持单一日志视图，不实现多标签页。原因：
- WebSocket 没有内置的主题概念，需要自定义消息分类规则
- 实现复杂度高，且大部分用户使用 MQTT 模式
- 可在未来版本中实现「多连接」方案（同时连接多个 WebSocket 服务器）

如需实现，采用「多连接管理」方案：
1. 允许用户添加多个 WebSocket URL
2. 每个连接对应一个独立标签页
3. 复用已有的 `TopicSession` 数据结构

#### 阶段 7: 优化与测试
**目标**: 性能优化和完善测试

1. 性能分析和优化
   - 大量消息场景测试
   - 内存泄漏检测
   - 渲染性能优化
2. 完善错误处理
   - 订阅失败处理
   - 网络断开恢复
   - 边界情况处理
3. 用户体验优化
   - 动画过渡
   - 键盘快捷键
   - 无障碍访问

#### 阶段 8: 文档与发布
**目标**: 完善文档和准备发布

1. 更新用户文档
2. 编写开发者文档
3. 准备发布说明
4. 创建使用示例和截图

### 4.2 任务依赖关系

```
阶段1 (基础架构)
    ↓
阶段2 (消息路由) ← 需要阶段1完成
    ↓
阶段3 (UI组件) ← 需要阶段1完成
    ↓
阶段4 (管理面板) ← 需要阶段3完成
    ↓
阶段5 (独立功能) ← 需要阶段2、3完成
    ↓
阶段6 (WS适配) ← 可与阶段2-5并行
    ↓
阶段7 (优化测试) ← 需要前面所有阶段完成
    ↓
阶段8 (文档发布)
```

---

## 五、技术细节

### 5.1 主题匹配算法

#### 5.1.1 匹配规则

| 订阅主题 | 消息主题 | 匹配结果 | 说明 |
|---------|---------|---------|------|
| `home/temp` | `home/temp` | ✅ 匹配 | 精确匹配 |
| `home/temp` | `home/humidity` | ❌ 不匹配 | 不同主题 |
| `home/+/temp` | `home/living/temp` | ✅ 匹配 | 单级通配符 |
| `home/+/temp` | `home/living/room/temp` | ❌ 不匹配 | 多级不匹配 |
| `home/#` | `home/living/room/temp` | ✅ 匹配 | 多级通配符 |
| `#` | `any/topic` | ✅ 匹配 | 全部匹配 |
| `home/#` | `home` | ✅ 匹配 | # 匹配零级或多级 |

> **注意**: 根据 MQTT 3.1.1 规范，`#` 通配符匹配零级或多级主题层次。
> 即 `home/#` 可以匹配 `home`、`home/living`、`home/living/room` 等。

#### 5.1.2 重要说明

**消息去向**: 当一条消息匹配多个订阅主题时（如 `home/temp` 同时匹配订阅的 `home/temp` 和 `home/#`），消息会分发到所有匹配的会话中。UI 会在标签页上显示消息可能重复的提示。

**重复订阅**: 系统会阻止用户订阅完全相同的主题。如果新主题与已有主题存在包含关系（如已订阅 `home/#`，又要订阅 `home/temp`），系统会发出警告但允许订阅。

#### 5.1.3 实现策略

- 将订阅主题拆分为段数组
- 将消息主题拆分为段数组
- 逐段比较，处理 `+` 和 `#` 通配符

### 5.2 性能优化策略

#### 5.2.1 日志数组管理

- **限制大小**: 每个会话默认最大 1000 条消息
- **FIFO 策略**: 超出限制时删除最旧的消息
- **虚拟滚动**: 只渲染可视区域的消息（可选）
- **延迟渲染**: 使用 `requestAnimationFrame` 批量更新

#### 5.2.2 内存管理

- **非活动会话**: 非 Tab 的消息日志限制更小（如 100 条）
- **定期清理**: 每分钟清理超限的消息
- **Lazy 加载**: 切换到 Tab 时才完整渲染

#### 5.2.3 消息处理

- **消息去重**: 可选的重复消息检测
- **批量处理**: 使用 `DocumentFragment` 批量插入 DOM
- **节流更新**: 高频消息时限制 UI 更新频率

### 5.3 主题颜色系统

#### 5.3.1 预设颜色

```javascript
const topicColors = [
  { name: 'blue', value: '#3b82f6', bg: 'rgba(59, 130, 246, 0.1)' },
  { name: 'green', value: '#10b981', bg: 'rgba(16, 185, 129, 0.1)' },
  { name: 'orange', value: '#f59e0b', bg: 'rgba(245, 158, 11, 0.1)' },
  { name: 'purple', value: '#8b5cf6', bg: 'rgba(139, 92, 246, 0.1)' },
  { name: 'pink', value: '#ec4899', bg: 'rgba(236, 72, 153, 0.1)' },
  { name: 'cyan', value: '#06b6d4', bg: 'rgba(6, 182, 212, 0.1)' },
];
```

#### 5.3.2 自动分配

- 创建主题时自动分配未使用的颜色
- 循环使用预设颜色
- 用户可在配置中手动修改

### 5.4 键盘快捷键

| 快捷键 | 功能 |
|--------|------|
| `Ctrl + Tab` | 切换到下一个 Tab |
| `Ctrl + Shift + Tab` | 切换到上一个 Tab |
| `Ctrl + 1-9` | 切换到指定编号的 Tab |
| `Ctrl + W` | 关闭当前 Tab |
| `Ctrl + T` | 添加新主题 |
| `Ctrl + ,` | 打开主题管理面板 |

---

## 六、测试计划

### 6.1 单元测试

#### 6.1.1 数据结构测试
- TopicSession 创建和更新
- 主题匹配算法
- 消息路由逻辑

#### 6.1.2 模块测试
- TopicManager 各方法
- SessionStorage 读写
- NotificationManager 触发

### 6.2 集成测试

#### 6.2.1 MQTT 多主题场景
- 同时订阅 5 个主题
- 通配符主题订阅
- 主题取消和重新订阅

#### 6.2.2 UI 交互测试
- Tab 切换响应
- 拖拽排序
- 配置修改生效

#### 6.2.3 数据持久化测试
- 关闭重开后恢复主题
- 配置保存和加载
- 日志清理验证

### 6.3 性能测试

#### 6.3.1 压力测试
- 每秒 100+ 消息场景
- 10+ 个主题同时订阅
- 长时间运行稳定性

#### 6.3.2 内存测试
- 24 小时运行内存占用
- 大量日志场景内存峰值
- 内存泄漏检测

### 6.4 用户场景测试

#### 6.4.1 典型使用场景
- Home Assistant 设备监控
- AWS IoT 主题调试
- 多区域传感器监控

#### 6.4.2 边界情况
- 网络断开恢复
- 订阅失败处理
- 主题名称特殊字符

---

## 七、风险评估

### 7.1 技术风险

| 风险 | 影响 | 缓解措施 |
|------|------|---------|
| 内存泄漏 | 高 | 严格的资源清理；定期内存测试 |
| 消息丢失 | 中 | 添加消息队列缓冲；异常处理 |
| UI 卡顿 | 中 | 虚拟滚动；批量渲染 |
| 主题匹配错误 | 高 | 完整的单元测试；边界验证 |
| WebSocket 多连接复杂性 | 高 | 考虑阶段 6 可选或延后 |

### 7.2 用户体验风险

| 风险 | 影响 | 缓解措施 |
|------|------|---------|
| 学习曲线陡峭 | 中 | 提供引导教程；默认配置 |
| Tab 混乱 | 低 | Tab 数量限制；分组功能 |
| 配置复杂 | 中 | 预设模板；快速添加 |

---

## 八、后续扩展

### 8.1 潜在功能

1. **主题文件夹**: 将主题分组到文件夹中
2. **消息搜索**: 跨所有主题搜索消息
3. **消息规则**: 自动过滤、转发、高亮特定消息
4. **图表展示**: 可视化传感器数据趋势
5. **消息录制**: 记录和回放消息流
6. **导入导出**: 分享主题配置和消息历史
7. **多连接**: 同时连接多个 MQTT Broker

### 8.2 技术演进

1. **迁移到框架**: 考虑使用 Vue/React 重构
2. **Web Workers**: 将消息处理移到 Worker
3. **IndexedDB**: 使用 IndexedDB 存储大量历史
4. **Service Worker**: 后台接收消息

---

## 九、里程碑与交付

### 9.1 里程碑定义

| 里程碑 | 阶段 | 交付物 |
|--------|------|--------|
| M1 | 阶段 1 | 基础数据结构和 TopicManager |
| M2 | 阶段 2 | 消息路由系统和多主题订阅 |
| M3 | 阶段 3 | Tab Bar UI 和切换功能 |
| M4 | 阶段 4 | 主题管理面板 |
| M5 | 阶段 5 | 完整的多主题功能（MQTT） |
| M6 | 阶段 6 | WebSocket 模式支持 |
| M7 | 阶段 7 | 性能优化和测试完成 |
| M8 | 阶段 8 | 文档和发布准备 |

### 9.2 MVP 范围

**最小可行产品（MVP）**: 包含阶段 1-5
- 支持多主题订阅和独立查看
- Tab 切换和管理
- 主题配置持久化
- 基本的消息过滤和导出

---

## 十、总结

本实施计划详细规划了多主题窗口功能的完整实现路径，从需求分析、UI 设计、技术架构到实施步骤和测试计划。

**核心价值**:
- 解决用户同时监控多个主题的痛点
- 提升调试和开发效率
- 为未来功能扩展打下基础

**关键成功因素**:
- 严格的数据结构设计
- 高效的消息路由算法
- 优雅的 UI/UX 实现
- 全面的测试覆盖

**建议实施顺序**: 按阶段顺序实施，每个阶段完成后进行测试验证，确保质量后再进入下一阶段。
