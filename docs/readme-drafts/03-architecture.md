# Architecture and Modules

## Project Structure

```
websocketExtension/
├── src/
│   ├── sidepanel.html          # Main HTML structure for the side panel
│   ├── sidepanel.js            # Core application logic and event handling
│   ├── styles.css              # Complete styling with CSS variables for theming
│   ├── modules/                # Multi-topic management system
│   │   ├── TopicManager.js     # Session lifecycle and topic matching
│   │   ├── TopicRouter.js      # Message routing to matching sessions
│   │   ├── TopicStorage.js     # Chrome storage persistence layer
│   │   ├── TabRenderer.js      # Tab bar UI rendering and interactions
│   │   └── index.js            # Module exports
│   └── tests/                  # Unit tests for modules
├── public/
│   ├── manifest.json           # Chrome extension manifest (V3)
│   └── icons/                  # Extension icons
├── docs/
│   └── readme-drafts/          # README section drafts
├── dist/                       # Build output (generated by Vite)
├── vite.config.js              # Vite configuration with Node polyfills
└── package.json                # Dependencies and build scripts
```

## Module Architecture

The multi-topic system follows a modular architecture with clear separation of concerns:

```
┌─────────────────────────────────────────────────────────────┐
│                      sidepanel.js (Main)                     │
│  - WebSocket/MQTT connection management                       │
│  - UI event handlers                                         │
│  - Module orchestration                                      │
└─────────────┬───────────────────────────────────────────────┘
              │
    ┌─────────┴─────────────────────────────┐
    │                                       │
    ▼                                       ▼
┌─────────────────┐                 ┌─────────────────┐
│  TopicManager   │◄────────────────│  TopicRouter    │
│  - Sessions     │                 │  - Message RX   │
│  - Active state │                 │  - Message TX   │
│  - Topic match  │                 │  - Sys messages │
└────────┬────────┘                 └─────────────────┘
         │                                   │
         │                                   │
    ┌────┴────────┐                   ┌──────┴───────┐
    │             │                   │              │
    ▼             ▼                   ▼              ▼
┌─────────┐ ┌──────────┐      ┌──────────┐  ┌────────────┐
│TabRender│ │TopicStore│      │   MQTT   │  │   Storage  │
│   UI    │ │  Config  │      │  Client  │  │chrome.local│
└─────────┘ └──────────┘      └──────────┘  └────────────┘
```

## Core Modules

### TopicManager

**Purpose**: Central state manager for all topic sessions. Handles session lifecycle, topic matching with MQTT wildcards, and active session tracking.

**Key Classes**:
- `TopicSession` - Represents a single topic subscription with logs, settings, and statistics
- `TopicManager` - Manages the collection of all sessions

**Key Methods**:

| Method | Description |
|--------|-------------|
| `createSession(topic, options)` | Creates a new topic session with auto-assigned color |
| `deleteSession(sessionId)` | Removes a session and updates active state |
| `switchToSession(sessionId)` | Changes active session and resets unread count |
| `getActiveSession()` | Returns the currently active TopicSession |
| `findMatchingSessions(messageTopic)` | Returns all sessions matching the message topic (supports wildcards) |
| `exportConfig()` / `importConfig()` | Serializes/deserializes session state for persistence |
| `matchTopic(pattern, topic)` | MQTT wildcard matching function |

**TopicSession Properties**:
```javascript
{
  id: string,              // Unique session identifier
  topic: string,           // MQTT subscription pattern
  displayName: string,     // Display name (defaults to topic)
  qos: number,             // Quality of Service level (0-2)
  color: string,           // Tab color hex value
  logs: Array,             // Message log entries
  maxLogs: number,         // Maximum log entries (default: 1000)
  isSubscribed: boolean,   // MQTT subscription state
  isPaused: boolean,       // Whether log collection is paused
  isMuted: boolean,        // Whether notifications are muted
  autoScroll: boolean,     // Auto-scroll to newest message
  jsonFormat: boolean,     // Format payloads as JSON
  unreadCount: number,     // Unread message counter
  totalReceived: number,   // Total messages received
  filter: string           // Log filter string
}
```

### TopicRouter

**Purpose**: Routes incoming MQTT messages to all matching TopicSession instances based on MQTT wildcard rules.

**Key Methods**:

| Method | Description |
|--------|-------------|
| `routeMessage(messageTopic, payload, meta)` | Routes received messages to all matching sessions |
| `addSentMessage(topic, message)` | Adds TX (sent) log entries to the matching or active session |
| `addSystemMessage(message, sessionId)` | Adds system messages to a specific or active session |
| `broadcastSystemMessage(message)` | Adds a system message to all sessions |

**Message Flow**:
```
MQTT Message Received
       │
       ▼
┌─────────────────────────┐
│  topicRouter.routeMessage() │
└────────────┬────────────┘
             │
             ▼
┌─────────────────────────┐
│ Find matching sessions  │
│ via matchTopic()        │
└────────────┬────────────┘
             │
             ▼
┌─────────────────────────┐
│ For each matching session: │
│  - Skip if paused        │
│  - Add log entry         │
│  - Increment unread      │
│    (if not active)       │
└─────────────────────────┘
```

### TopicStorage

**Purpose**: Provides persistence layer using Chrome's `chrome.storage.local` API. Automatically saves session configuration on changes.

**Storage Keys**:

| Key | Description |
|-----|-------------|
| `ws:topicConfigs` | Array of TopicSession configuration objects |
| `ws:activeTopicId` | ID of the currently active session |
| `ws:topicOrder` | Array of session IDs in tab order |

**Key Methods**:

| Method | Description |
|--------|-------------|
| `saveAll()` | Persists all session configurations to storage |
| `loadAll()` | Restores sessions from storage |
| `saveActiveTopicId()` | Saves only the active session ID |
| `clearAll()` | Removes all topic data from storage |
| `hasStoredConfig()` | Checks if any saved configuration exists |

**Note**: Log messages are NOT persisted. Only session configuration (topic, QoS, display name, color, settings) is saved.

### TabRenderer

**Purpose**: Renders the tab bar UI and handles tab interactions. Observes TopicManager state changes and re-renders automatically.

**Key Methods**:

| Method | Description |
|--------|-------------|
| `init(containerId)` | Initializes renderer with DOM container |
| `render()` | Renders all tabs based on current sessions |
| `updateBadge(sessionId)` | Updates unread count badge for a specific tab |
| `updateIndicator(sessionId, status)` | Updates subscription status indicator |

**Callbacks**:
- `onTabClick(sessionId)` - Fired when a tab is clicked
- `onTabClose(sessionId, topic)` - Fired when close button is clicked
- `onAddTopic()` - Fired when add button is clicked

**Tab States**:
```
┌────────────────────────────────────┐
│ ● home/living   [2]        ×       │  ← Active, subscribed, 2 unread
├────────────────────────────────────┤
│ ○ home/bedroom            ×        │  ← Subscribed
├────────────────────────────────────┤
│ ○ sensors/#              ×        │  ← Unsubscribed
└────────────────────────────────────┘
```

## Multi-Topic Data Flow

### Subscription Flow

```
User adds topic
       │
       ▼
┌──────────────────┐
│ TopicManager     │
│ .createSession() │
└────────┬─────────┘
         │
         ▼
┌──────────────────┐      ┌──────────────────┐
│ TabRenderer      │      │ TopicStorage     │
│ .render()        │      │ .saveAll()       │
└──────────────────┘      └──────────────────┘
         │
         ▼
┌──────────────────┐
│ MQTT Client      │
│ .subscribe()     │
└──────────────────┘
```

### Message Reception Flow

```
MQTT Message Arrived on "home/living/temp"
       │
       ▼
┌─────────────────────────────────────┐
│ TopicRouter.routeMessage()          │
│ Finds matching sessions:            │
│  - "home/living/temp" (exact)       │
│  - "home/+/temp" (single wildcard)  │
│  - "home/#" (multi wildcard)        │
└─────────────┬───────────────────────┘
              │
              ▼
┌─────────────────────────────────────┐
│ For each matching session:          │
│  1. Check if paused → skip          │
│  2. Add log entry                   │
│  3. If not active → increment unread│
└─────────────┬───────────────────────┘
              │
              ▼
┌─────────────────────────────────────┐
│ TabRenderer.updateBadge()           │
│ (if unread count changed)           │
└─────────────────────────────────────┘
```

## Storage Schema

### chrome.storage.local Structure

```javascript
{
  // Single-topic mode (legacy)
  "ws:url": "wss://broker.example.com:8883",
  "ws:idleSeconds": 300,
  "ws:history": ["payload1", "payload2"],
  "ws:historySize": 20,
  "ws:theme": "dark",
  "ws:connConfig": { /* connection config */ },

  // Multi-topic mode
  "ws:topicConfigs": [
    {
      "id": "abc-123",
      "topic": "home/living/#",
      "displayName": "Living Room",
      "qos": 1,
      "color": "#3b82f6",
      "colorBg": "rgba(59, 130, 246, 0.1)",
      "maxLogs": 1000,
      "autoScroll": true,
      "jsonFormat": true,
      "isPaused": false,
      "created": 1704067200000
    },
    // ... more session configs
  ],
  "ws:activeTopicId": "abc-123",
  "ws:topicOrder": ["abc-123", "def-456", "ghi-789"]
}
```

## MQTT Wildcard Matching

The `matchTopic()` function implements standard MQTT wildcard rules:

| Pattern | Matches | Does Not Match |
|---------|---------|----------------|
| `home/temp` | `home/temp` | `home/humidity` |
| `home/+` | `home/temp`, `home/humidity` | `home/living/temp` |
| `home/#` | `home`, `home/temp`, `home/living/temp` | `office/temp` |
| `#` | Any topic | (none) |
| `+/+/temp` | `home/living/temp`, `office/bedroom/temp` | `home/temp` |

**Implementation**: See `TopicManager.js:172-217`

## Integration with Main Application

The multi-topic modules integrate with `sidepanel.js` through:

1. **Initialization**: Modules are imported and initialized on page load
2. **Event Handlers**: TabRenderer callbacks (`onTabClick`, `onTabClose`, `onAddTopic`) are wired to UI handlers
3. **MQTT Client**: The MQTT client's `on('message')` handler calls `topicRouter.routeMessage()`
4. **State Persistence**: `topicStorage.saveAll()` is called when sessions are modified
