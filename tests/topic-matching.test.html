<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ä¸»é¢˜åŒ¹é…ç®—æ³•æµ‹è¯•</title>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 900px;
      margin: 0 auto;
      padding: 20px;
      background: #1a1a2e;
      color: #eee;
    }
    h1 { color: #3b82f6; margin-bottom: 8px; }
    .subtitle { color: #888; margin-bottom: 24px; }
    .test-group {
      background: #16213e;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 16px;
    }
    .test-group h2 {
      margin: 0 0 12px 0;
      font-size: 16px;
      color: #8b5cf6;
    }
    .test-row {
      display: flex;
      align-items: center;
      padding: 8px 12px;
      border-radius: 4px;
      margin-bottom: 4px;
      font-family: 'Monaco', 'Consolas', monospace;
      font-size: 14px;
    }
    .test-row.pass { background: rgba(16, 185, 129, 0.1); }
    .test-row.fail { background: rgba(239, 68, 68, 0.1); }
    .status {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 12px;
      font-size: 14px;
    }
    .status.pass { background: #10b981; }
    .status.fail { background: #ef4444; }
    .test-info { flex: 1; }
    .test-name { font-weight: 500; }
    .test-detail { color: #888; font-size: 12px; margin-top: 2px; }
    .summary {
      background: #0f3460;
      border-radius: 8px;
      padding: 16px;
      margin-top: 24px;
      text-align: center;
    }
    .summary.all-pass { border: 2px solid #10b981; }
    .summary.has-fail { border: 2px solid #ef4444; }
    .summary h3 { margin: 0 0 8px 0; }
    .summary .count { font-size: 24px; font-weight: bold; }
    .summary .count.pass { color: #10b981; }
    .summary .count.fail { color: #ef4444; }
    #run-btn {
      background: #3b82f6;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 6px;
      font-size: 16px;
      cursor: pointer;
      margin-bottom: 24px;
    }
    #run-btn:hover { background: #2563eb; }
  </style>
</head>
<body>
  <h1>ğŸ§ª å¤šä¸»é¢˜æ¨¡å—æµ‹è¯•</h1>
  <p class="subtitle">æµ‹è¯• MQTT ä¸»é¢˜åŒ¹é…ç®—æ³•å’Œ TopicManager åŠŸèƒ½</p>
  
  <button id="run-btn">è¿è¡Œæ‰€æœ‰æµ‹è¯•</button>
  
  <div id="results"></div>
  <div id="summary" class="summary" style="display: none;"></div>

  <script type="module">
    // ===== å†…è” matchTopic å‡½æ•°ï¼ˆç”¨äºç‹¬ç«‹æµ‹è¯•ï¼‰ =====
    function matchTopic(subscriptionPattern, messageTopic) {
      if (!subscriptionPattern || !messageTopic) return false;
      if (subscriptionPattern === messageTopic) return true;
      if (subscriptionPattern === '#') return true;
      
      const patternParts = subscriptionPattern.split('/');
      const topicParts = messageTopic.split('/');
      
      for (let i = 0; i < patternParts.length; i++) {
        const patternPart = patternParts[i];
        
        if (patternPart === '#') {
          return true;
        }
        
        if (i >= topicParts.length) {
          return false;
        }
        
        const topicPart = topicParts[i];
        
        if (patternPart === '+') {
          continue;
        }
        
        if (patternPart !== topicPart) {
          return false;
        }
      }
      
      return patternParts.length === topicParts.length;
    }

    // ===== æµ‹è¯•ç”¨ä¾‹ =====
    const testCases = [
      // ç²¾ç¡®åŒ¹é…
      {
        group: 'ç²¾ç¡®åŒ¹é…',
        tests: [
          { pattern: 'home/temp', topic: 'home/temp', expected: true, desc: 'å®Œå…¨ç›¸åŒ' },
          { pattern: 'home/temp', topic: 'home/humidity', expected: false, desc: 'ä¸åŒä¸»é¢˜' },
          { pattern: 'a/b/c', topic: 'a/b/c', expected: true, desc: 'å¤šå±‚çº§ç²¾ç¡®åŒ¹é…' },
          { pattern: 'a/b/c', topic: 'a/b/d', expected: false, desc: 'æœ€åä¸€çº§ä¸åŒ' },
        ]
      },
      // å•çº§é€šé…ç¬¦ +
      {
        group: 'å•çº§é€šé…ç¬¦ (+)',
        tests: [
          { pattern: 'home/+/temp', topic: 'home/living/temp', expected: true, desc: 'ä¸­é—´åŒ¹é…ä»»æ„' },
          { pattern: 'home/+/temp', topic: 'home/living/room/temp', expected: false, desc: 'ä¸èƒ½åŒ¹é…å¤šçº§' },
          { pattern: '+/temp', topic: 'home/temp', expected: true, desc: 'å¼€å¤´åŒ¹é…ä»»æ„' },
          { pattern: 'home/+', topic: 'home/temp', expected: true, desc: 'ç»“å°¾åŒ¹é…ä»»æ„' },
          { pattern: '+/+/+', topic: 'a/b/c', expected: true, desc: 'å¤šä¸ªå•çº§é€šé…ç¬¦' },
          { pattern: '+', topic: 'home', expected: true, desc: 'å•ä¸ª+åŒ¹é…å•å±‚çº§' },
        ]
      },
      // å¤šçº§é€šé…ç¬¦ #
      {
        group: 'å¤šçº§é€šé…ç¬¦ (#)',
        tests: [
          { pattern: 'home/#', topic: 'home/living/room/temp', expected: true, desc: 'åŒ¹é…å¤šçº§' },
          { pattern: 'home/#', topic: 'home/temp', expected: true, desc: 'åŒ¹é…å•çº§' },
          { pattern: 'home/#', topic: 'home', expected: true, desc: 'åŒ¹é…é›¶çº§ (MQTT 3.1.1)' },
          { pattern: '#', topic: 'any/topic/here', expected: true, desc: 'å…¨åŒ¹é…' },
          { pattern: '#', topic: 'single', expected: true, desc: 'å•å±‚çº§å…¨åŒ¹é…' },
          { pattern: 'sensors/#', topic: 'sensors', expected: true, desc: '# åŒ¹é…é›¶çº§' },
        ]
      },
      // è¾¹ç•Œæƒ…å†µ
      {
        group: 'è¾¹ç•Œæƒ…å†µ',
        tests: [
          { pattern: '', topic: 'home', expected: false, desc: 'ç©ºè®¢é˜…ä¸»é¢˜' },
          { pattern: 'home', topic: '', expected: false, desc: 'ç©ºæ¶ˆæ¯ä¸»é¢˜' },
          { pattern: 'home/+/#', topic: 'home/living/room/temp', expected: true, desc: 'æ··åˆé€šé…ç¬¦' },
          { pattern: '$SYS/#', topic: '$SYS/broker/clients', expected: true, desc: 'ç³»ç»Ÿä¸»é¢˜' },
          { pattern: 'home/temp', topic: 'HOME/temp', expected: false, desc: 'å¤§å°å†™æ•æ„Ÿ' },
        ]
      },
    ];

    // ===== æµ‹è¯•è¿è¡Œå™¨ =====
    function runTests() {
      const resultsDiv = document.getElementById('results');
      const summaryDiv = document.getElementById('summary');
      resultsDiv.innerHTML = '';
      
      let passCount = 0;
      let failCount = 0;

      for (const group of testCases) {
        const groupDiv = document.createElement('div');
        groupDiv.className = 'test-group';
        groupDiv.innerHTML = `<h2>${group.group}</h2>`;

        for (const test of group.tests) {
          const result = matchTopic(test.pattern, test.topic);
          const passed = result === test.expected;
          
          if (passed) passCount++;
          else failCount++;

          const row = document.createElement('div');
          row.className = `test-row ${passed ? 'pass' : 'fail'}`;
          row.innerHTML = `
            <div class="status ${passed ? 'pass' : 'fail'}">${passed ? 'âœ“' : 'âœ—'}</div>
            <div class="test-info">
              <div class="test-name">${test.desc}</div>
              <div class="test-detail">
                matchTopic("${test.pattern}", "${test.topic}") 
                â†’ ${result} (é¢„æœŸ: ${test.expected})
              </div>
            </div>
          `;
          groupDiv.appendChild(row);
        }

        resultsDiv.appendChild(groupDiv);
      }

      // æ˜¾ç¤ºæ€»ç»“
      summaryDiv.style.display = 'block';
      summaryDiv.className = `summary ${failCount === 0 ? 'all-pass' : 'has-fail'}`;
      summaryDiv.innerHTML = `
        <h3>æµ‹è¯•ç»“æœ</h3>
        <span class="count pass">${passCount} é€šè¿‡</span>
        ${failCount > 0 ? `<span class="count fail"> / ${failCount} å¤±è´¥</span>` : ''}
      `;
    }

    // ç»‘å®šæŒ‰é’®äº‹ä»¶
    document.getElementById('run-btn').addEventListener('click', runTests);
    
    // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è¿è¡Œ
    runTests();
  </script>
</body>
</html>
